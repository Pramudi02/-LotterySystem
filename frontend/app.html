<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lottery System</title>
    <link rel="stylesheet" href="app-styles.css">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <!-- Navigation Bar (Hidden on auth page) -->
    <nav class="navbar" id="navbar" style="display: none;">
        <div class="navbar-content">
            <a href="#" class="navbar-brand" onclick="navigateTo('dashboard')">üé∞ Lottery System</a>
            <div class="navbar-nav">
                <a href="#" class="nav-link" data-page="dashboard" onclick="navigateTo('dashboard')">Dashboard</a>
                <a href="#" class="nav-link" data-page="play" onclick="navigateTo('play')">Play Lottery</a>
                <a href="#" class="nav-link" data-page="results" onclick="navigateTo('results')">My Results</a>
                <a href="#" class="nav-link" data-page="admin" onclick="navigateTo('admin')" style="display: none;">Admin Panel</a>
            </div>
            <div class="user-info">
                <span id="navUserName">Welcome!</span>
                <button class="btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Authentication Page -->
    <div id="authPage" class="page active">
        <div class="auth-container">
            <div class="auth-header">
                <h1>üé∞ Lottery System</h1>
                <p>Welcome! Sign in or create an account to start playing</p>
            </div>

            <div class="auth-card">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="signin" onclick="switchAuthTab('signin')">
                        <span>üîê</span> Sign In
                    </button>
                    <button class="auth-tab" data-tab="signup" onclick="switchAuthTab('signup')">
                        <span>‚ú®</span> Create Account
                    </button>
                </div>

                <!-- Sign In Form -->
                <form id="signinForm" class="auth-form active" onsubmit="handleSignIn(event)">
                    <h2>Sign In</h2>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="signinEmail" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signinPassword" required placeholder="Enter password">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <span>üöÄ</span> Sign In
                    </button>
                </form>

                <!-- Sign Up Form -->
                <form id="signupForm" class="auth-form" onsubmit="handleSignUp(event)">
                    <h2>Create Account</h2>
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" id="signupName" required placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="signupEmail" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signupPassword" required placeholder="Create password (min 6 chars)">
                    </div>
                    <button type="submit" class="btn btn-success">
                        <span>üéâ</span> Create Account
                    </button>
                </form>

                <div id="authMessage" class="auth-message"></div>
            </div>

            <div class="auth-footer">
                <p>üéÅ Start with $100 bonus credit!</p>
                <p>Each ticket costs $10 and gives you 5 numbers (1-100)</p>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="page">
        <div class="container">
            <div class="page-header">
                <h1>Welcome, <span id="dashUserName"></span>!</h1>
                <div class="balance-display">
                    <span class="balance-label">Balance:</span>
                    <span class="balance-amount" id="dashBalance">$0.00</span>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card" onclick="navigateTo('play')">
                    <div class="card-icon">üé´</div>
                    <h3>Play Lottery</h3>
                    <p>Buy tickets and try your luck!</p>
                </div>

                <div class="dashboard-card" onclick="navigateTo('results')">
                    <div class="card-icon">üìä</div>
                    <h3>My Results</h3>
                    <p>Check your tickets and winnings</p>
                </div>

                <div class="dashboard-card" id="adminCard" style="display: none;" onclick="navigateTo('admin')">
                    <div class="card-icon">‚öôÔ∏è</div>
                    <h3>Admin Panel</h3>
                    <p>Manage lottery system</p>
                </div>
            </div>

            <div class="info-section">
                <h3>üéØ How It Works</h3>
                <ul>
                    <li>Each ticket costs $10 and contains 5 random numbers (1-100)</li>
                    <li>Match the winning number to win $100!</li>
                    <li>Admin sets the winning number</li>
                    <li>Check your results anytime</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Play Lottery Page -->
    <div id="playPage" class="page">
        <div class="container">
            <div class="page-header">
                <h1>üé´ Play Lottery</h1>
                <div class="balance-display">
                    <span class="balance-label">Balance:</span>
                    <span class="balance-amount" id="playBalance">$0.00</span>
                </div>
            </div>

            <div class="ticket-purchase">
                <div class="ticket-info">
                    <h3>Buy Lottery Ticket</h3>
                    <p>Cost: <strong>$10.00</strong> per ticket</p>
                    <p>You will receive 5 random numbers (1-100)</p>
                </div>
                <button id="buyTicketBtn" class="btn btn-large btn-success" onclick="buyTicket()">
                    <span>üé∞</span> Buy Ticket ($10)
                </button>
                <div id="ticketMessage" class="message-box"></div>
            </div>

            <div id="recentTicket" class="recent-ticket" style="display: none;">
                <h3>üéâ Your New Ticket</h3>
                <div id="ticketNumbers" class="ticket-numbers"></div>
            </div>
        </div>
    </div>

    <!-- Results Page -->
    <div id="resultsPage" class="page">
        <div class="container">
            <div class="page-header">
                <h1>üìä My Results</h1>
                <div class="balance-display">
                    <span class="balance-label">Balance:</span>
                    <span class="balance-amount" id="resultsBalance">$0.00</span>
                </div>
            </div>

            <button class="btn btn-primary" onclick="loadResults()">
                <span>üîÑ</span> Refresh Results
            </button>

            <div id="winningNumberDisplay" class="winning-number-display">
                <h3>üéØ Winning Number: <span id="winningNumberValue">Not Set</span></h3>
            </div>

            <div id="ticketsList" class="tickets-list">
                <p class="empty-message">No tickets yet. Buy a ticket to get started!</p>
            </div>
        </div>
    </div>

    <!-- Admin Page -->
    <div id="adminPage" class="page">
        <div class="container">
            <div class="page-header">
                <h1>‚öôÔ∏è Admin Panel</h1>
            </div>

            <div class="admin-section">
                <h3>Set Winning Number</h3>
                <div class="form-inline">
                    <input type="number" id="winningNumberInput" min="1" max="100" placeholder="Enter number (1-100)">
                    <button class="btn btn-danger" onclick="setWinningNumber()">
                        <span>üéØ</span> Set Winner
                    </button>
                </div>
                <div id="winnerMessage" class="message-box"></div>
            </div>

            <div class="admin-section">
                <h3>All Tickets</h3>
                <button class="btn btn-info" onclick="loadAllTickets()">
                    <span>üé´</span> View All Tickets
                </button>
                <div id="allTicketsList" class="admin-list"></div>
            </div>

            <div class="admin-section">
                <h3>All Users</h3>
                <button class="btn btn-info" onclick="loadAllUsers()">
                    <span>üë•</span> View All Users
                </button>
                <div id="allUsersList" class="admin-list"></div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <!-- Toast Messages -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, getDocs, addDoc, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWEtzjum1mcPN3e61XghXaNC9qum7vhDw",
            authDomain: "lotterysystem-18963.firebaseapp.com",
            projectId: "lotterysystem-18963",
            storageBucket: "lotterysystem-18963.firebasestorage.app",
            messagingSenderId: "41637006495",
            appId: "1:41637006495:web:e7c9e6e3a57792bbc126aa",
            measurementId: "G-HKLLXJNVHS"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let currentUserData = null;

        // Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                if (document.getElementById('authPage').classList.contains('active')) {
                    navigateTo('dashboard');
                }
            } else {
                currentUser = null;
                currentUserData = null;
                navigateTo('auth');
            }
        });

        // Load User Data
        async function loadUserData() {
            try {
                const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                } else {
                    // Create user document if doesn't exist
                    currentUserData = {
                        email: currentUser.email,
                        displayName: currentUser.displayName || currentUser.email,
                        balance: 100.0,
                        isAdmin: false,
                        createdAt: Timestamp.now()
                    };
                    await setDoc(doc(db, "users", currentUser.uid), currentUserData);
                }

                updateUIWithUserData();
            } catch (error) {
                console.error("Error loading user data:", error);
                showToast("Error loading user data", "error");
            }
        }

        // Update UI with User Data
        function updateUIWithUserData() {
            const displayName = currentUserData.displayName || currentUser.email;
            const balance = currentUserData.balance || 0;

            document.getElementById('navUserName').textContent = displayName;
            document.getElementById('dashUserName').textContent = displayName;
            
            updateBalance(balance);

            // Show/hide admin features
            const isAdmin = currentUserData.isAdmin || false;
            document.querySelector('[data-page="admin"]').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('adminCard').style.display = isAdmin ? 'flex' : 'none';
        }

        // Update Balance Display
        function updateBalance(balance) {
            const formatted = `$${balance.toFixed(2)}`;
            document.getElementById('dashBalance').textContent = formatted;
            document.getElementById('playBalance').textContent = formatted;
            document.getElementById('resultsBalance').textContent = formatted;
        }

        // Navigation
        window.navigateTo = function(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));

            // Show target page
            if (page === 'auth') {
                document.getElementById('authPage').classList.add('active');
                document.getElementById('navbar').style.display = 'none';
            } else {
                document.getElementById(`${page}Page`).classList.add('active');
                document.getElementById('navbar').style.display = 'block';

                // Update active nav link
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.dataset.page === page) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });

                // Load page-specific data
                if (page === 'results') loadResults();
                if (page === 'play') loadPlayPageData();
            }
        };

        // Auth Tab Switching
        window.switchAuthTab = function(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(`${tab}Form`).classList.add('active');

            document.getElementById('authMessage').textContent = '';
        };

        // Sign In
        window.handleSignIn = async function(event) {
            event.preventDefault();
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;

            showLoading(true);
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast("Signed in successfully!", "success");
            } catch (error) {
                showAuthMessage(error.message, "error");
            } finally {
                showLoading(false);
            }
        };

        // Sign Up
        window.handleSignUp = async function(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;

            if (password.length < 6) {
                showAuthMessage("Password must be at least 6 characters", "error");
                return;
            }

            showLoading(true);
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // Create user document
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    email: email,
                    displayName: name,
                    balance: 100.0,
                    isAdmin: false,
                    createdAt: Timestamp.now()
                });

                showToast("Account created successfully!", "success");
            } catch (error) {
                showAuthMessage(error.message, "error");
            } finally {
                showLoading(false);
            }
        };

        // Logout
        window.logout = async function() {
            try {
                await signOut(auth);
                showToast("Signed out successfully", "success");
            } catch (error) {
                showToast("Error signing out", "error");
            }
        };

        // Buy Ticket
        window.buyTicket = async function() {
            if (!currentUser) return;

            const btn = document.getElementById('buyTicketBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span> Processing...';

            try {
                // Check balance
                if (currentUserData.balance < 10) {
                    showMessage('ticketMessage', 'Insufficient balance!', 'error');
                    return;
                }

                // Generate random numbers
                const numbers = Array.from({length: 5}, () => Math.floor(Math.random() * 100) + 1);

                // Create ticket
                await addDoc(collection(db, "tickets"), {
                    userId: currentUser.uid,
                    numbers: numbers,
                    purchaseTime: Timestamp.now(),
                    checked: false
                });

                // Update balance
                const newBalance = currentUserData.balance - 10;
                await updateDoc(doc(db, "users", currentUser.uid), {
                    balance: newBalance
                });

                currentUserData.balance = newBalance;
                updateBalance(newBalance);

                // Display ticket
                displayNewTicket(numbers);
                showMessage('ticketMessage', 'Ticket purchased successfully!', 'success');
                showToast("Ticket purchased! Good luck!", "success");

            } catch (error) {
                console.error("Error buying ticket:", error);
                showMessage('ticketMessage', 'Error purchasing ticket', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>üé∞</span> Buy Ticket ($10)';
            }
        };

        // Display New Ticket
        function displayNewTicket(numbers) {
            const ticketDiv = document.getElementById('recentTicket');
            const numbersDiv = document.getElementById('ticketNumbers');
            
            numbersDiv.innerHTML = numbers.map(n => 
                `<div class="number-ball">${n}</div>`
            ).join('');
            
            ticketDiv.style.display = 'block';
        }

        // Load Play Page Data
        function loadPlayPageData() {
            document.getElementById('recentTicket').style.display = 'none';
            document.getElementById('ticketMessage').textContent = '';
        }

        // Load Results
        window.loadResults = async function() {
            if (!currentUser) return;

            showLoading(true);
            try {
                // Get winning number
                const systemDoc = await getDoc(doc(db, "system", "lottery"));
                const winningNumber = systemDoc.exists() ? systemDoc.data().winningNumber : null;
                
                document.getElementById('winningNumberValue').textContent = 
                    winningNumber ? winningNumber : 'Not Set';

                // Get user tickets
                const q = query(
                    collection(db, "tickets"),
                    where("userId", "==", currentUser.uid),
                    orderBy("purchaseTime", "desc")
                );
                
                const snapshot = await getDocs(q);
                const tickets = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    tickets.push({
                        id: doc.id,
                        numbers: data.numbers,
                        purchaseTime: data.purchaseTime.toDate(),
                        won: winningNumber && data.numbers.includes(winningNumber)
                    });
                });

                displayTickets(tickets, winningNumber);

            } catch (error) {
                console.error("Error loading results:", error);
                showToast("Error loading results", "error");
            } finally {
                showLoading(false);
            }
        };

        // Display Tickets
        function displayTickets(tickets, winningNumber) {
            const container = document.getElementById('ticketsList');
            
            if (tickets.length === 0) {
                container.innerHTML = '<p class="empty-message">No tickets yet. Buy a ticket to get started!</p>';
                return;
            }

            container.innerHTML = tickets.map(ticket => {
                const wonClass = ticket.won ? 'winner' : '';
                const wonText = ticket.won ? 'üéâ WINNER! +$100' : 'No win';
                
                return `
                    <div class="ticket-card ${wonClass}">
                        <div class="ticket-header">
                            <span class="ticket-date">${ticket.purchaseTime.toLocaleString()}</span>
                            <span class="ticket-result ${wonClass}">${wonText}</span>
                        </div>
                        <div class="ticket-numbers">
                            ${ticket.numbers.map(n => {
                                const matchClass = n === winningNumber ? 'match' : '';
                                return `<div class="number-ball ${matchClass}">${n}</div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Admin: Set Winning Number
        window.setWinningNumber = async function() {
            if (!currentUserData?.isAdmin) {
                showToast("Admin access required", "error");
                return;
            }

            const input = document.getElementById('winningNumberInput');
            const number = parseInt(input.value);

            if (!number || number < 1 || number > 100) {
                showMessage('winnerMessage', 'Please enter a number between 1 and 100', 'error');
                return;
            }

            showLoading(true);
            try {
                await setDoc(doc(db, "system", "lottery"), {
                    winningNumber: number,
                    setTime: Timestamp.now()
                }, { merge: true });

                showMessage('winnerMessage', `Winning number set to ${number}`, 'success');
                showToast("Winning number updated!", "success");
                input.value = '';

            } catch (error) {
                console.error("Error setting winning number:", error);
                showMessage('winnerMessage', 'Error setting winning number', 'error');
            } finally {
                showLoading(false);
            }
        };

        // Admin: Load All Tickets
        window.loadAllTickets = async function() {
            if (!currentUserData?.isAdmin) return;

            showLoading(true);
            try {
                const snapshot = await getDocs(collection(db, "tickets"));
                const tickets = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    tickets.push({
                        id: doc.id,
                        userId: data.userId.substring(0, 8),
                        numbers: data.numbers,
                        time: data.purchaseTime.toDate()
                    });
                });

                const container = document.getElementById('allTicketsList');
                if (tickets.length === 0) {
                    container.innerHTML = '<p class="empty-message">No tickets yet</p>';
                } else {
                    container.innerHTML = `
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>User ID</th>
                                    <th>Numbers</th>
                                    <th>Purchase Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tickets.map(t => `
                                    <tr>
                                        <td>${t.userId}...</td>
                                        <td>${t.numbers.join(', ')}</td>
                                        <td>${t.time.toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

            } catch (error) {
                console.error("Error loading tickets:", error);
                showToast("Error loading tickets", "error");
            } finally {
                showLoading(false);
            }
        };

        // Admin: Load All Users
        window.loadAllUsers = async function() {
            if (!currentUserData?.isAdmin) return;

            showLoading(true);
            try {
                const snapshot = await getDocs(collection(db, "users"));
                const users = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    users.push({
                        email: data.email,
                        name: data.displayName,
                        balance: data.balance || 0,
                        isAdmin: data.isAdmin || false
                    });
                });

                const container = document.getElementById('allUsersList');
                if (users.length === 0) {
                    container.innerHTML = '<p class="empty-message">No users yet</p>';
                } else {
                    container.innerHTML = `
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Name</th>
                                    <th>Balance</th>
                                    <th>Role</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(u => `
                                    <tr>
                                        <td>${u.email}</td>
                                        <td>${u.name}</td>
                                        <td>$${u.balance.toFixed(2)}</td>
                                        <td>${u.isAdmin ? 'üëë Admin' : 'User'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }

            } catch (error) {
                console.error("Error loading users:", error);
                showToast("Error loading users", "error");
            } finally {
                showLoading(false);
            }
        };

        // Utility Functions
        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showMessage(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.textContent = message;
            container.className = `message-box ${type}`;
            setTimeout(() => {
                container.textContent = '';
                container.className = 'message-box';
            }, 5000);
        }

        function showAuthMessage(message, type) {
            const msgDiv = document.getElementById('authMessage');
            msgDiv.textContent = message;
            msgDiv.className = `auth-message ${type}`;
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Make functions globally accessible
        window.auth = auth;
        window.db = db;
    </script>
</body>
</html>
