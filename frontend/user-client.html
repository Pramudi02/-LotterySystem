<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lottery System - User Client</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBWEtzjum1mcPN3e61XghXaNC9qum7vhDw",
            authDomain: "lotterysystem-18963.firebaseapp.com",
            projectId: "lotterysystem-18963",
            storageBucket: "lotterysystem-18963.firebasestorage.app",
            messagingSenderId: "41637006495",
            appId: "1:41637006495:web:e7c9e6e3a57792bbc126aa",
            measurementId: "G-HKLLXJNVHS"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
    </script>
    <script type="module" src="firebase-config.js"></script>
<body>
    <div class="container">
        <header>
            <h1>Lottery System</h1>
            <p>Welcome, <span id="userDisplayName">User</span>!</p>
            <button id="backBtn" class="btn btn-secondary">‚Üê Back to Main</button>
        </header>

        <div class="auth-section" id="authSection">
            <h2>Authentication Required</h2>
            <p>Please wait while we verify your authentication...</p>
            <div id="authStatus" class="status">Checking...</div>
        </div>

        <div class="user-section" id="userSection" style="display: none;">
            <h2>User Dashboard</h2>
            <div class="balance-info">
                <h3>Account Balance: $<span id="balance">0.00</span></h3>
            </div>

            <div class="ticket-section">
                <h3>Buy Lottery Ticket</h3>
                <p>Cost: $10.00 per ticket (5 random numbers between 1-100)</p>
                <button id="buyTicketBtn" class="btn btn-warning">Buy Ticket</button>
                <div id="ticketStatus" class="status"></div>
            </div>

            <div class="results-section">
                <h3>Check Results</h3>
                <button id="checkResultsBtn" class="btn btn-info">Check Results</button>
                <div id="resultsStatus" class="status"></div>
                <div id="resultsDisplay" class="results-display" style="display: none;">
                    <h4>Your Tickets:</h4>
                    <div id="userTickets"></div>
                </div>
            </div>
        </div>

        <div class="messages-section">
            <h2>Messages</h2>
            <div id="messages" class="messages-container"></div>
        </div>
    </div>

    <script type="module">
        import { firebaseAuth, firebaseDB } from './firebase-config.js';

        let currentUser = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            firebaseAuth.onAuthStateChange(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadUserData();
                    showUserSection();
                } else {
                    showAuthSection();
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            });

            // Event listeners
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });

            document.getElementById('buyTicketBtn').addEventListener('click', buyTicket);
            document.getElementById('checkResultsBtn').addEventListener('click', checkResults);
        });

        // Load user data
        async function loadUserData() {
            if (!currentUser) return;

            const result = await firebaseDB.getUserData(currentUser.uid);
            if (result.success) {
                const userData = result.data;
                document.getElementById('userDisplayName').textContent = userData.displayName || currentUser.email;
                document.getElementById('balance').textContent = userData.balance?.toFixed(2) || '0.00';
            } else {
                showMessage('Failed to load user data: ' + result.error, 'error');
            }
        }

        // Buy ticket
        async function buyTicket() {
            if (!currentUser) {
                showMessage('Please log in first', 'error');
                return;
            }

            const ticketBtn = document.getElementById('buyTicketBtn');
            ticketBtn.disabled = true;
            ticketBtn.textContent = 'Processing...';

            const result = await firebaseDB.buyTicket(currentUser.uid);
            if (result.success) {
                showMessage(`Ticket purchased! Numbers: ${result.numbers.join(', ')}`, 'success');
                document.getElementById('balance').textContent = result.balance.toFixed(2);
            } else {
                showMessage('Failed to buy ticket: ' + result.error, 'error');
            }

            ticketBtn.disabled = false;
            ticketBtn.textContent = 'Buy Ticket';
        }

        // Check results
        async function checkResults() {
            if (!currentUser) {
                showMessage('Please log in first', 'error');
                return;
            }

            const resultsBtn = document.getElementById('checkResultsBtn');
            resultsBtn.disabled = true;
            resultsBtn.textContent = 'Checking...';

            try {
                // Get user's tickets
                const ticketsResult = await firebaseDB.getUserTickets(currentUser.uid);
                if (!ticketsResult.success) {
                    showMessage('Failed to load tickets: ' + ticketsResult.error, 'error');
                    return;
                }

                // Get winning number
                const winningResult = await firebaseDB.getWinningNumber();
                if (!winningResult.success) {
                    showMessage('Failed to get winning number: ' + winningResult.error, 'error');
                    return;
                }

                const winningNumber = winningResult.winningNumber;
                const tickets = ticketsResult.tickets;

                // Display results
                displayResults(tickets, winningNumber);

                if (tickets.length === 0) {
                    showMessage('No tickets found. Buy a ticket first!', 'info');
                } else {
                    showMessage(`Results checked! Winning number: ${winningNumber || 'Not set'}`, 'success');
                }
            } catch (error) {
                showMessage('Error checking results: ' + error.message, 'error');
            }

            resultsBtn.disabled = false;
            resultsBtn.textContent = 'Check Results';
        }

        // Display results
        function displayResults(tickets, winningNumber) {
            const resultsDisplay = document.getElementById('resultsDisplay');
            const userTickets = document.getElementById('userTickets');

            if (tickets.length === 0) {
                userTickets.innerHTML = '<p>No tickets purchased yet.</p>';
                resultsDisplay.style.display = 'block';
                return;
            }

            let html = '<div class="tickets-grid">';
            html += `<div class="winning-number">üéØ Winning Number: ${winningNumber || 'Not set yet'}</div>`;

            tickets.forEach(ticket => {
                const won = winningNumber && ticket.numbers.includes(winningNumber);
                const prize = won ? 100 : 0;

                html += `
                    <div class="ticket-card ${won ? 'winner' : ''}">
                        <div class="ticket-numbers">
                            ${ticket.numbers.map(num =>
                                `<span class="number ${num === winningNumber ? 'match' : ''}">${num}</span>`
                            ).join('')}
                        </div>
                        <div class="ticket-info">
                            <div>Purchased: ${ticket.purchaseTime.toLocaleString()}</div>
                            <div class="${won ? 'win-text' : 'loss-text'}">
                                ${won ? `üéâ Winner! Prize: $${prize}` : 'No win this time'}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            userTickets.innerHTML = html;
            resultsDisplay.style.display = 'block';
        }

        // Show auth section
        function showAuthSection() {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('userSection').style.display = 'none';
        }

        // Show user section
        function showUserSection() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'block';
        }

        // Show message
        function showMessage(text, type = 'info') {
            const messages = document.getElementById('messages');
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = text;
            messages.appendChild(messageEl);

            // Auto remove after 5 seconds
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }
    </script>
</body>
</html>